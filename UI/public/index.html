<!DOCTYPE html>
<html lang="en-us">

	<head>
		<meta charset="UTF-8">
		<!--
		Viewport out for now as it causes weird scaling issus on mobile
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		-->

		<title>piEQ</title>
		
		<script src="js/NexusUI.js"></script>
		<script src="js/jquery-3.5.1.min.js"></script>
		<script src="js/socket.io.js"></script>
		<style>
			/* Preset saving popup */
			.modal {
				display: none; /* Hidden by default */
				position: fixed; /* Stay in place */
				z-index: 2; /* Sit on top */
				padding-top: 100px; /* Location of the box */
				left: 0;
				top: 0;
				width: 100%; /* Full width */
				height: 100%; /* Full height */
				overflow: auto; /* Enable scroll if needed */
				background-color: rgb(0,0,0); /* Fallback color */
				background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
			}
			.modal-content {
				background-color: #FFFFFF;
				margin: auto;
				padding: 20px;
				border: 1px solid;
				width: 50%;
			}
			.close {
				color: #aaaaaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
			}

			.close:hover,
			.close:focus {
				color: #000;
				text-decoration: none;
				cursor: pointer;
			}
			
			.overlay {
				display:none;
				background:#fff; 
				bottom:0; 
				left:0; 
				opacity:.5; 
				position:absolute; 
				right:0; 
				top:0;
				z-index:1;
			}
			
			.peak {
				width: 100px;
			}
		</style>
	</head>

	<body>
		<div id="savemodal" class="modal">
			<!-- Modal content -->
			<div class="modal-content">
				<span class="close">&times;</span>
				<!--<form style="width:50%;margin:auto;text-align:center;">-->
				<form>
					<table>
						<tr>
							<td>
								<p>Save Preset</p>
							</td>
							<td>
								<p>Load Preset</p>
							</td>
						</tr>
						<tr>
							<td>
								<input type="text" id="savepresetname" value="Preset Name"></input>
							</td>
							<td>
								<div id="selectpreset"></div>
							</td>
						</tr>
						<tr>
							<td>
								<div id="savebutton"></div>
							</td>
							<td>
								<div id="loadbutton"></div>
							</td>
						</tr>
					</table>
				</form>
			</div>
		</div>
		
		<div id="mainui">
			<table>
				<tr>
					<td>
						<p>Pre-gain (dB)</p>
					</td>
					<td>
						<div style="position:relative;">
							<div class="overlay" id="pgsoverlay"></div>
							<div nexus-ui="slider" id="pgs"></div>
						</div>
					</td>
					<td>
						<div style="position:relative;">
							<div class="overlay" id="pgnoverlay"></div>
							<div nexus-ui="number" id="pgn"></div>
						</div>
					</td>
					<td>
						<div nexus-ui="textbutton" id="reset"></div>
					</td>
					<td>
						<div nexus-ui="textbutton" id="preset"></div>
					</td>
					<td style="width:200px;text-align:center;">
						<p>Bypass</p>
						<div nexus-ui="toggle" id="bypass" style="margin:auto;"></div>
					</td>
				</tr>
			</table>
			<div style="height:80px;"></div>
			<div style="position:relative;">
				<div id="bpoverlay" class="overlay"></div>
				<table>
					<tr>
						<td>
						</td>
						<td>
							<div style="position:relative;">
								<div class="overlay" id="gs0overlay"></div>
								<div nexus-ui="slider" id="gs0"></div>
							</div>
						</td>
						<td>
							<div nexus-ui="slider" id="gs1"></div>
						</td>
						<td>
							<div nexus-ui="slider" id="gs2"></div>
						</td>
						<td>
							<div nexus-ui="slider" id="gs3"></div>
						</td>
						<td>
							<div nexus-ui="slider" id="gs4"></div>
						</td>
						<td>
							<div nexus-ui="slider" id="gs5"></div>
						</td>
						<td>
							<div nexus-ui="slider" id="gs6"></div>
						</td>
						<td>
							<div nexus-ui="slider" id="gs7"></div>
						</td>
						<td>
							<div nexus-ui="slider" id="gs8"></div>
						</td>
						<td>
							<div style="position:relative;">
								<div class="overlay" id="gs9overlay"></div>
								<div nexus-ui="slider" id="gs9"></div>
							</div>
						</td>
					</tr>
					<tr>
						<td>
							<p>Gain (dB)</p>
						</td>
						<td>
							<div style="position:relative;">
								<div class="overlay" id="gn0overlay"></div>
								<div nexus-ui="number" id="gn0"></div>
							</div>
						</td>
						<td>
							<div nexus-ui="number" id="gn1"></div>
						</td>
						<td>
							<div nexus-ui="number" id="gn2"></div>
						</td>
						<td>
							<div nexus-ui="number" id="gn3"></div>
						</td>
						<td>
							<div nexus-ui="number" id="gn4"></div>
						</td>
						<td>
							<div nexus-ui="number" id="gn5"></div>
						</td>
						<td>
							<div nexus-ui="number" id="gn6"></div>
						</td>
						<td>
							<div nexus-ui="number" id="gn7"></div>
						</td>
						<td>
							<div nexus-ui="number" id="gn8"></div>
						</td>
						<td>
							<div style="position:relative;">
								<div class="overlay" id="gn9overlay"></div>
								<div nexus-ui="number" id="gn9"></div>
							</div>
						</td>
					</tr>
					<tr>
						<td>
							<p>Type</p>
						</td>
						<td>
							<div nexus-ui="select" id="fs0"></div>
						</td>
						<td class="peak">
							<p>Peak</p>
						</td>
						<td class="peak">
							<p>Peak</p>
						</td>
						<td class="peak">
							<p>Peak</p>
						</td>
						<td class="peak">
							<p>Peak</p>
						</td>
						<td class="peak">
							<p>Peak</p>
						</td>
						<td class="peak">
							<p>Peak</p>
						</td>
						<td class="peak">
							<p>Peak</p>
						</td>
						<td class="peak">
							<p>Peak</p>
						</td>
						<td>
							<div nexus-ui="select" id="fs9"></div>
						</td>
					</tr>
					<tr>
						<td>
							<p>Freq (Hz)</p>
						</td>
						<td>
							<div nexus-ui="number" id="fn0"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn1"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn2"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn3"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn4"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn5"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn6"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn7"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn8"></div>
						</td>
						<td>
							<div nexus-ui="number" id="fn9"></div>
						</td>
					</tr>
					<tr>
						<td>
							<p>Q</p>
						</td>
						<td>
							<div style="position:relative;">
								<div class="overlay" id="qn0overlay"></div>
								<div nexus-ui="number" id="qn0"></div>
							</div>
						</td>
						<td>
							<div nexus-ui="number" id="qn1"></div>
						</td>
						<td>
							<div nexus-ui="number" id="qn2"></div>
						</td>
						<td>
							<div nexus-ui="number" id="qn3"></div>
						</td>
						<td>
							<div nexus-ui="number" id="qn4"></div>
						</td>
						<td>
							<div nexus-ui="number" id="qn5"></div>
						</td>
						<td>
							<div nexus-ui="number" id="qn6"></div>
						</td>
						<td>
							<div nexus-ui="number" id="qn7"></div>
						</td>
						<td>
							<div nexus-ui="number" id="qn8"></div>
						</td>
						<td>
							<div style="position:relative;">
								<div class="overlay" id="qn9overlay"></div>
								<div nexus-ui="number" id="qn9"></div>
							</div>
						</td>
					</tr>
				</table>
			</div>
		</div>
		
		<script>
			var mainui = new Nexus.Rack("#mainui");
			
			//set attributes.  Sizes are pretty goofy on mobile landscape mode, need to make this responsive
			
			mainui.pgs.resize (240, 80)
			
			mainui.gs0.resize (80, 480);
			mainui.gs1.resize (80, 480);
			mainui.gs2.resize (80, 480);
			mainui.gs3.resize (80, 480);
			mainui.gs4.resize (80, 480);
			mainui.gs5.resize (80, 480);
			mainui.gs6.resize (80, 480);
			mainui.gs7.resize (80, 480);
			mainui.gs8.resize (80, 480);
			mainui.gs9.resize (80, 480);
			
			mainui.pgs.min = -20;
			
			mainui.gs0.min = -20;
			mainui.gs1.min = -20;
			mainui.gs2.min = -20;
			mainui.gs3.min = -20;
			mainui.gs4.min = -20;
			mainui.gs5.min = -20;
			mainui.gs6.min = -20;
			mainui.gs7.min = -20;
			mainui.gs8.min = -20;
			mainui.gs9.min = -20;
			
			mainui.pgs.max = 20;
			
			mainui.gs0.max = 20;
			mainui.gs1.max = 20;
			mainui.gs2.max = 20;
			mainui.gs3.max = 20;
			mainui.gs4.max = 20;
			mainui.gs5.max = 20;
			mainui.gs6.max = 20;
			mainui.gs7.max = 20;
			mainui.gs8.max = 20;
			mainui.gs9.max = 20;
			
			mainui.pgs.step = 0.1;
			
			mainui.gs0.step = 0.1;
			mainui.gs1.step = 0.1;
			mainui.gs2.step = 0.1;
			mainui.gs3.step = 0.1;
			mainui.gs4.step = 0.1;
			mainui.gs5.step = 0.1;
			mainui.gs6.step = 0.1;
			mainui.gs7.step = 0.1;
			mainui.gs8.step = 0.1;
			mainui.gs9.step = 0.1;
			
			mainui.pgn.link(mainui.pgs);
			
			mainui.gn0.link(mainui.gs0);
			mainui.gn1.link(mainui.gs1);
			mainui.gn2.link(mainui.gs2);
			mainui.gn3.link(mainui.gs3);
			mainui.gn4.link(mainui.gs4);
			mainui.gn5.link(mainui.gs5);
			mainui.gn6.link(mainui.gs6);
			mainui.gn7.link(mainui.gs7);
			mainui.gn8.link(mainui.gs8);
			mainui.gn9.link(mainui.gs9);
			
			mainui.fn0.min = 20;
			mainui.fn1.min = 20;
			mainui.fn2.min = 20;
			mainui.fn3.min = 20;
			mainui.fn4.min = 20;
			mainui.fn5.min = 20;
			mainui.fn6.min = 20;
			mainui.fn7.min = 20;
			mainui.fn8.min = 20;
			mainui.fn9.min = 20;
			
			mainui.fn0.max = 20000;
			mainui.fn1.max = 20000;
			mainui.fn2.max = 20000;
			mainui.fn3.max = 20000;
			mainui.fn4.max = 20000;
			mainui.fn5.max = 20000;
			mainui.fn6.max = 20000;
			mainui.fn7.max = 20000;
			mainui.fn8.max = 20000;
			mainui.fn9.max = 20000;
			
			mainui.fn0.step = 1;
			mainui.fn1.step = 1;
			mainui.fn2.step = 1;
			mainui.fn3.step = 1;
			mainui.fn4.step = 1;
			mainui.fn5.step = 1;
			mainui.fn6.step = 1;
			mainui.fn7.step = 1;
			mainui.fn8.step = 1;
			mainui.fn9.step = 1;
			
			mainui.fn0.value = 31;
			mainui.fn1.value = 62;
			mainui.fn2.value = 125;
			mainui.fn3.value = 250;
			mainui.fn4.value = 500;
			mainui.fn5.value = 1000;
			mainui.fn6.value = 2000;
			mainui.fn7.value = 4000;
			mainui.fn8.value = 8000;
			mainui.fn9.value = 16000;
			
			mainui.qn0.min = 0.10;
			mainui.qn1.min = 0.10;
			mainui.qn2.min = 0.10;
			mainui.qn3.min = 0.10;
			mainui.qn4.min = 0.10;
			mainui.qn5.min = 0.10;
			mainui.qn6.min = 0.10;
			mainui.qn7.min = 0.10;
			mainui.qn8.min = 0.10;
			mainui.qn8.min = 0.10;
			
			mainui.qn0.max = 10;
			mainui.qn1.max = 10;
			mainui.qn2.max = 10;
			mainui.qn3.max = 10;
			mainui.qn4.max = 10;
			mainui.qn5.max = 10;
			mainui.qn6.max = 10;
			mainui.qn7.max = 10;
			mainui.qn8.max = 10;
			mainui.qn9.max = 10;
			
			mainui.qn0.step = 0.01;
			mainui.qn1.step = 0.01;
			mainui.qn2.step = 0.01;
			mainui.qn3.step = 0.01;
			mainui.qn4.step = 0.01;
			mainui.qn5.step = 0.01;
			mainui.qn6.step = 0.01;
			mainui.qn7.step = 0.01;
			mainui.qn8.step = 0.01;
			mainui.qn9.step = 0.01;
			
			mainui.qn0.value = 1.41;
			mainui.qn1.value = 1.41;
			mainui.qn2.value = 1.41;
			mainui.qn3.value = 1.41;
			mainui.qn4.value = 1.41;
			mainui.qn5.value = 1.41;
			mainui.qn6.value = 1.41;
			mainui.qn7.value = 1.41;
			mainui.qn8.value = 1.41;
			mainui.qn9.value = 1.41;
			
			mainui.fs0.defineOptions(["Peak", "Low Shelf", "High Pass"]);
			mainui.fs9.defineOptions(["Peak", "High Shelf", "Low Pass"]);
			
			mainui.reset.text = "Reset";
			mainui.preset.text = "Preset";
			
			//mainui.bypass.resize(100, 80);
						
			//function to pass control data back to node 
			var socket = io()
			
			function postControl (data) {
				uiChanged = true; //trigger to save the state
				//console.log(data.filter);
				//console.log(data.value);
				socket.emit('control', data);
			}
			
			// event handlers for GUI elements, post data through socket to node to send osc to pd 
			
			mainui.pgs.on('change', function(v){
				var data = {filter: "pg", param: "gain", value: v};
				postControl(data);
			})
			
			
			//set change event behavior for gain sliders
			
			//attempt to do a loop doesn't work.
			/*var gsData = []; //Array to hold gain slider identifiers
			for (var i = 0; i < 9; i++){
				var gsi = "gs" + i;
				mainui[gsi].on('change', function(v){
					//var index = i;
					gsData[i] = {filter: "f" + i, param: "gain", value: v};
					postControl(gsData[i]);
				});
			}
			*/
			mainui.gs0.on('change', function(v){
				var data = {filter: "f0", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs1.on('change', function(v){
				var data = {filter: "f1", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs2.on('change', function(v){
				var data = {filter: "f2", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs3.on('change', function(v){
				var data = {filter: "f3", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs4.on('change', function(v){
				var data = {filter: "f4", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs5.on('change', function(v){
				var data = {filter: "f5", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs6.on('change', function(v){
				var data = {filter: "f6", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs7.on('change', function(v){
				var data = {filter: "f7", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs8.on('change', function(v){
				var data = {filter: "f8", param: "gain", value: v};
				postControl(data);
			})
			mainui.gs9.on('change', function(v){
				var data = {filter: "f9", param: "gain", value: v};
				postControl(data);
			})
			
			//change event data for freq number boxes
			mainui.fn0.on('change', function(v){
				var data = {filter: "f0", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn1.on('change', function(v){
				var data = {filter: "f1", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn2.on('change', function(v){
				var data = {filter: "f2", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn3.on('change', function(v){
				var data = {filter: "f3", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn4.on('change', function(v){
				var data = {filter: "f4", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn5.on('change', function(v){
				var data = {filter: "f5", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn6.on('change', function(v){
				var data = {filter: "f6", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn7.on('change', function(v){
				var data = {filter: "f7", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn8.on('change', function(v){
				var data = {filter: "f8", param: "freq", value: v};
				postControl(data);
			})
			mainui.fn9.on('change', function(v){
				var data = {filter: "f9", param: "freq", value: v};
				postControl(data);
			})
			
			//change event data for Q number boxes
			mainui.qn0.on('change', function(v){
				var data = {filter: "f0", param: "q", value: v};
				postControl(data);
			})
			mainui.qn1.on('change', function(v){
				var data = {filter: "f1", param: "q", value: v};
				postControl(data);
			})
			mainui.qn2.on('change', function(v){
				var data = {filter: "f2", param: "q", value: v};
				postControl(data);
			})
			mainui.qn3.on('change', function(v){
				var data = {filter: "f3", param: "q", value: v};
				postControl(data);
			})
			mainui.qn4.on('change', function(v){
				var data = {filter: "f4", param: "q", value: v};
				postControl(data);
			})
			mainui.qn5.on('change', function(v){
				var data = {filter: "f5", param: "q", value: v};
				postControl(data);
			})
			mainui.qn6.on('change', function(v){
				var data = {filter: "f6", param: "q", value: v};
				postControl(data);
			})
			mainui.qn7.on('change', function(v){
				var data = {filter: "f7", param: "q", value: v};
				postControl(data);
			})
			mainui.qn8.on('change', function(v){
				var data = {filter: "f8", param: "q", value: v};
				postControl(data);
			})
			mainui.qn9.on('change', function(v){
				var data = {filter: "f9", param: "q", value: v};
				postControl(data);
			})
			
			//filter select actions
			mainui.fs0.on('change', function(v){
				var data = {filter: "f0", param: "type", value: v.index};
				postControl(data);
				
				if (v.index == 0){
					$('#gs0overlay, #gn0overlay, #qn0overlay').hide();
				}else if (v.index == 1){
					$('#gs0overlay, #gn0overlay').hide();
					$('#qn0overlay').show();
				}else if (v.index == 2){
					$('#gs0overlay, #gn0overlay, #qn0overlay').show();
				}
			})
			
			mainui.fs9.on('change', function(v){
				var data = {filter: "f9", param: "type", value: v.index};
				postControl(data);
				
				if (v.index == 0){
					$('#gs9overlay, #gn9overlay, #qn9overlay').hide();
				}else if (v.index == 1){
					$('#gs9overlay, #gn9overlay').hide();
					$('#qn9overlay').show();
				}else if (v.index == 2){
					$('#gs9overlay, #gn9overlay, #qn9overlay').show();
				}
			})
			
			//bypass button
			mainui.bypass.on('change', function (v){
				//console.log(v);
				if (v == true){
					$('#bpoverlay, #pgsoverlay, #pgnoverlay').show();
					
					var data = {filter: "bypass", param: "state", value: v};
					postControl(data);
				}else{
					$('#bpoverlay, #pgsoverlay, #pgnoverlay').hide();
		
					var data = {filter: "bypass", param: "state", value: v};
					postControl(data);
				}
			});
			
			
			//Quick reset function
			
			mainui.reset.on('change', function (v){
				if (mainui.reset.state == false){
					reset();
				}
			})
			
			function reset(){
				for (var i = 0; i < 10; i++){
					var gsi = "gs" + i;
					mainui[gsi].value = 0;
					
					var qni = "qn" + i;
					mainui[qni].value = 1.41;
				}
				mainui.pgs.value = 0;
				
				mainui.fn0.value = 31;
				mainui.fn1.value = 62;
				mainui.fn2.value = 125;
				mainui.fn3.value = 250;
				mainui.fn4.value = 500;
				mainui.fn5.value = 1000;
				mainui.fn6.value = 2000;
				mainui.fn7.value = 4000;
				mainui.fn8.value = 8000;
				mainui.fn9.value = 16000;
				
				mainui.fs0.value = "Peak";
				mainui.fs9.value = "Peak";
			}
			
			
			//Preset UI display controls.  Need to add input sanitization
			
			var saveButton = new Nexus.TextButton('#savebutton');
			var selectPreset = new Nexus.Select('#selectpreset');
			var loadButton = new Nexus.TextButton('#loadbutton');
			
			saveButton.text = "Save"
			loadButton.text = "Load"
			
			selectPreset.defineOptions([]);
			
			mainui.preset.on('change', function (v){
				if (mainui.preset.state == false){
					$('#savemodal').css("display", "block");
					listPresets();
				}
			})	
			
			saveButton.on('change', function (v){
				if (saveButton.state == false){
					var presetName = $('#savepresetname').val();
					savePreset(presetName);
					$('#savemodal').css("display", "none");
				}
			})	
			
			loadButton.on('change', function (v){
				if (loadButton.state == false){
					loadPreset(selectPreset.value);
					$('#savepresetname').val(selectPreset.value);
					$('#savemodal').css("display", "none");
				}
			})
			
			$('.close').click(function(e){
				$('.modal').css("display", "none");
			})
			
			$(window).click(function(e){
				if (e.target.className == "modal"){
					$('.modal').css("display", "none");
				}
			})
			
			
			//saving current state of all UI elements in JSON to store presets
			var currentState = {};
			var uiChanged = true; //only save current state if UI changed to reduce overhead
			
			//set currentState JSON object and post to server (should be done on a timer)
			function setCurrentState (){
				if (uiChanged){
					for (var key in mainui){
						if (mainui.hasOwnProperty(key)){
							if (key == "fs0" || key == "fs9"){ //special for filter type selects
								currentState[key] = {"value" : mainui[key].selectedIndex}
							}
							else if (key == "bypass"){
								currentState[key] = {"value" : mainui[key].state};
							}
							else{
								currentState[key] = {"value" : mainui[key].value}
							}
						}
					}
					$.ajax({
						url: '/savecurrentstate', 
						type: "POST",
						contentType: 'application/json',
						data: JSON.stringify(currentState)
					});
				}
				uiChanged = false;
			}
			
			//function to save a preset to the server
			function savePreset(presetName){
				var preset = currentState;
				preset["name"] = presetName;
				delete preset["bypass"]; //don't save bypass state to a preset
				$.ajax({
						url: '/savepreset', 
						type: "POST",
						contentType: 'application/json',
						data: JSON.stringify(preset)
				});
			}
			
			// function to load a preset from the server
			function loadPreset(presetName){
				$.ajax({
					url: '/loadpreset', 
					type: "POST",
					contentType: 'application/json',
					data: JSON.stringify({"preset" : presetName}),
					success: function (data){
						//console.log(data);
						var preset = JSON.parse(data);
						for (var key in preset){
							if (preset.hasOwnProperty(key)){
								if (key != "name") {
									if (key == "fs0" || key == "fs9"){
										mainui[key].selectedIndex = preset[key]["value"]
									}
									mainui[key]["value"] = preset[key]["value"]; 
								}
							}
						}
					}
				});
			}
			
			//function to get list of presets
			function listPresets(){
				$.ajax({
					url: '/listpresets',
					success: function (data){
						selectPreset.defineOptions(data);
						selectPreset.selectedIndex = 0;
					}
				});
			}
			
			//function to request the "current state", or last state the UI was in
			function loadCurrentState(){
				$.ajax({
					url: '/loadcurrentstate', 
					success: function (data){
						//console.log(data);
						var preset = JSON.parse(data);
						for (var key in preset){
							if (preset.hasOwnProperty(key)){
								if (key != "name"){
									if (key == "fs0" || key == "fs9"){
										mainui[key].selectedIndex = preset[key]["value"]
									}
									else if (key == "bypass"){
										//var bpstate = (preset[key]["value"] == 'true');
										mainui[key].state = preset[key]["value"]
									}
									else{
										mainui[key]["value"] = preset[key]["value"];
									}
								}
							}
						}
					}
				});
			}
			
			//load the previous saved state on window refresh
			$( document ).ready(function() {
				loadCurrentState();
			});
			
			setInterval(setCurrentState, 2000); //save the current state every 2 seconds, will only fire if there are changes
						
		</script>
	</body>

</html>